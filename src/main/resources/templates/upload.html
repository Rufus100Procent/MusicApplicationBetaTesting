<!DOCTYPE html>
<html>
<head>
  <title>Song Upload</title>
  <style>
    #songTable {
      margin: 0 auto;
      width: 80%;
      border-collapse: collapse;
    }

    #songTable th,
    #songTable td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .playing {
      background-color: green;
    }

    .errorMessage {
      color: red;
    }
  </style>
</head>
<body>
<div style="text-align: center;">
  <button id="addSongButton" onclick="toggleForm()">Add Song</button>
</div>

<div id="songForm" style="display: none; text-align: center;">
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="text" name="songName" id="songName" placeholder="Song Name" required><br>
    <input type="text" name="artistName" id="artistName" placeholder="Artist Name" required><br>
    <input type="text" name="album" id="album" placeholder="Album"><br>
    <input type="number" name="releaseYear" id="releaseYear" placeholder="Release Year" required><br>
    <input type="file" name="file" id="fileInput" required><br>
    <button type="submit">Upload</button>
  </form>
</div>

<table id="songTable">
  <thead>
  <tr>
    <th>Actions</th>
    <th>Song Name</th>
    <th>Artist</th>
    <th>Album</th>
    <th>Year</th>
  </tr>
  </thead>
  <tbody id="songList"></tbody>
</table>

<div style="text-align: center;">
  <button id="prevButton" onclick="playPreviousSong()">Previous</button>
  <audio id="audioPlayer" controls></audio>
  <button id="nextButton" onclick="playNextSong()">Next</button>
</div>

<!-- Error message elements -->
<p id="songNameErrorMessage" class="errorMessage"></p>
<p id="mp3ErrorMessage" class="errorMessage"></p>
<p id="duplicateErrorMessage" class="errorMessage"></p>

<script>
  var songs = [];  // Array to store the songs
  var currentSongIndex = 0;  // Index of the currently playing song

  // Function to toggle the display of the song form
  function toggleForm() {
    var songForm = document.getElementById('songForm');
    var addSongButton = document.getElementById('addSongButton');

    if (songForm.style.display === 'none') {
      songForm.style.display = 'block';
      addSongButton.textContent = 'Cancel';
    } else {
      songForm.style.display = 'none';
      addSongButton.textContent = 'Add Song';
    }
  }

  // Function to play the previous song
  function playPreviousSong() {
    currentSongIndex--;
    if (currentSongIndex < 0) {
      currentSongIndex = songs.length - 1;
    }
    playSongByIndex(currentSongIndex);
  }

  // Function to play the next song
  function playNextSong() {
    currentSongIndex++;
    if (currentSongIndex >= songs.length) {
      currentSongIndex = 0;
    }
    playSongByIndex(currentSongIndex);
  }

  // Function to play a song by index
  function playSongByIndex(index) {
    currentSongIndex = index;
    var song = songs[index];

    fetch('/songs/' + song.id + '/file')
            .then(function (response) {
              if (!response.ok) {
                throw new Error('Failed to retrieve the song file');
              }
              return response.blob();
            })
            .then(function (blob) {
              var fileUrl = URL.createObjectURL(blob);
              var audioPlayer = document.getElementById('audioPlayer');
              audioPlayer.src = fileUrl;
              audioPlayer.play();
              updateButtonStates();
              highlightCurrentSong();
            })
            .catch(function (error) {
              console.error('Error:', error);
            });
  }

  // Function to update the states of the previous and next buttons
  function updateButtonStates() {
    var prevButton = document.getElementById('prevButton');
    var nextButton = document.getElementById('nextButton');

    prevButton.disabled = false;
    nextButton.disabled = false;
  }

  // Function to highlight the currently playing song
  function highlightCurrentSong() {
    var rows = document.querySelectorAll('#songList tr');

    for (var i = 0; i < rows.length; i++) {
      rows[i].classList.remove('playing');
    }

    var currentRow = document.getElementById('songRow' + currentSongIndex);
    currentRow.classList.add('playing');
  }

  // Function to display song name error message
  function displaySongNameErrorMessage(message) {
    var errorMessage = document.getElementById('songNameErrorMessage');
    errorMessage.textContent = message;
  }

  // Function to display MP3 file error message
  function displayMP3ErrorMessage(message) {
    var errorMessage = document.getElementById('mp3ErrorMessage');
    errorMessage.textContent = message;
  }

  // Function to display duplicate error message
  function displayDuplicateErrorMessage(message) {
    var errorMessage = document.getElementById('duplicateErrorMessage');
    errorMessage.textContent = message;
  }

  // Submit the form data and handle the response
  document.getElementById('uploadForm').addEventListener('submit', function (e) {
    e.preventDefault();
    var fileInput = document.getElementById('fileInput');
    var file = fileInput.files[0];

    var fileName = file.name;
    var fileExtension = fileName.split('.').pop().toLowerCase();
    if (fileExtension !== 'mp3') {
      displayErrorMessage('Invalid file format. Only MP3 files are allowed.');
      return;
    }

    // Validate file MIME type
    var fileMimeType = file.type;
    if (fileMimeType !== 'audio/mpeg') {
      displayErrorMessage('Invalid file format. Only MP3 files are allowed.');
      return;
    }

    var formData = new FormData();
    formData.append('file', file);
    formData.append('songName', document.getElementById('songName').value);
    formData.append('artistName', document.getElementById('artistName').value);
    formData.append('album', document.getElementById('album').value || '');
    formData.append('releaseYear', document.getElementById('releaseYear').value);

    fetch('/songs/upload', {
      method: 'POST',
      body: formData
    })
            .then(function (response) {
              if (!response.ok) {
                throw new Error('Failed to upload the song');
              }
              return response.json();
            })
            .then(function (song) {
              songs.push(song);

              var songList = document.getElementById('songList');

              var row = document.createElement('tr');
              row.id = 'songRow' + (songs.length - 1);
              row.innerHTML = `
        <td>
          <button class="playButton" onclick="playSongByIndex(${songs.length - 1})">Play</button>
        </td>
        <td>${song.songName}</td>
        <td>${song.artistName}</td>
        <td>${song.album || ''}</td>
        <td>${song.releaseYear}</td>
      `;

              songList.appendChild(row);
              updateButtonStates();
            })
            .catch(function (error) {
              console.error('Error:', error);
              // Handle specific errors for duplicate song names and duplicate MP3 uploads
              if (error.message === 'Song name already exists') {
                // Display an error message for duplicate song names
                displaySongNameErrorMessage('The song name already exists.');
                // Clear other error messages
                displayMP3ErrorMessage('');
                displayDuplicateErrorMessage('');
              } else if (error.message === 'MP3 file already uploaded') {
                // Display an error message for duplicate MP3 uploads
                displayMP3ErrorMessage('The MP3 file has already been uploaded.');
                // Clear other error messages
                displaySongNameErrorMessage('');
                displayDuplicateErrorMessage('');
              } else if (error.message === 'Both song name and MP3 file already exist') {
                // Display an error message for duplicate song names and MP3 uploads
                displayDuplicateErrorMessage('You cannot upload duplicates of both the song name and MP3 file.');
                // Clear other error messages
                displaySongNameErrorMessage('');
                displayMP3ErrorMessage('');
              } else {
                // Display a generic error message for other errors
                displaySongNameErrorMessage('Failed to upload the song.');
                // Clear other error messages
                displayMP3ErrorMessage('');
                displayDuplicateErrorMessage('');
              }
            });
  });
</script>
</body>
</html>
