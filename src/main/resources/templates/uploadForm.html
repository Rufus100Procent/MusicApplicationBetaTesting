<!DOCTYPE html>
<html lang="en">
<head>
  <title>Song Upload</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 100px;
    }

    h1 {
      text-align: inherit;
    }

    form {
      margin-bottom: 10px;
    }

    form input[type="file"],
    form input[type="text"],
    form input[type="submit"] {
      display: block;
      margin-bottom: 2px;
      width: 20%;
      padding: 1px;
      margin: 1px;

    }
    form input[type="file"]{
      display: block;
      margin-bottom: 1px;
      width: 50%;
      padding: 5px;
    }
    /*Create button*/
    form input[type="submit"] {
      display: block;
      margin-bottom: 10px;
      width: 10%;
      padding: 3px;
      background-color: #18a620;
      color: #f5f2f2;
      cursor: pointer;
    }
    #errorMessage {
      color: red;
      margin-bottom: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      height: 10px;
    }

    table td {
      border: 0.01px solid #52934f;
      padding: 1px;
      text-align: center;
    }

    table th {
      background-color: #6796ee;
    }

    audio {
      width: 100%;
      margin-top: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<h1>Song Upload</h1>

<form method="post" action="/upload" enctype="multipart/form-data" onsubmit="return validateForm()">
  <input type="file" name="file" required><br>
  <input type="text" name="songName" placeholder="Song Name" required><br>
  <input type="text" name="artist" placeholder="Artist" required><br>
  <input type="text" name="releaseYear" id="releaseYear" placeholder="Release Year" required><br>
  <input type="text" name="album" placeholder="Album"><br>
  <input type="submit" value="Create">
</form>

<p id="errorMessage"></p>

<table>
  <thead>
  <tr>
    <th>Song Name</th>
    <th>Artist</th>
    <th>Release Year</th>
    <th>Album</th>
    <th>Actions</th>
  </tr>
  </thead>
  <tbody id="songList"></tbody>
</table>

<audio controls id="audioPlayer"></audio>

<script>
  fetch('/songs')
          .then(response => response.json())
          .then(data => {
            const songList = document.getElementById('songList');
            data.forEach(songDetails => {
              const row = document.createElement('tr');
              row.innerHTML = `
          <td>${songDetails.songName}</td>
          <td>${songDetails.artist}</td>
          <td>${songDetails.releaseYear}</td>
          <td>${songDetails.album ? songDetails.album : '-'}</td>
          <td>
            <button onClick="playSong(${songDetails.id}, '${songDetails.filePath}')">Play</button>
          </td>
        `;
              songList.appendChild(row);
            });
          })
          .catch(error => console.error(error));

  // Function to play the selected song
  function playSong(id, filePath) {
    const audioPlayer = document.getElementById('audioPlayer');
    const url = `/songs/${id}/file`;

    fetch(url)
            .then(response => {
              if (!response.ok) {
                throw new Error('Failed to fetch song.');
              }
              return response.blob();
            })
            .then(blob => {
              const objectURL = URL.createObjectURL(blob);
              audioPlayer.src = objectURL;
              audioPlayer.load();
              audioPlayer.play();
            })
            .catch(error => {
              console.error(error);
            });
  }

  // Function to validate the release year
  function validateForm() {
    const releaseYearInput = document.getElementById('releaseYear');
    const releaseYear = releaseYearInput.value.trim();

    if (releaseYear.length !== 4 || isNaN(releaseYear)) {
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = 'Please enter a valid 4-digit release year.';
      return false; // Prevent form submission
    }

    return true; // Allow form submission
  }
</script>
</body>
</html>